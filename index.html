<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Synthium</title>
</head>

<style>
    /********** Universal Checkbox Styles **********/
    input[type="checkbox"] {
        /* Reset default checkbox appearance */
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 1.5rem;
        height: 1.5rem;
        border: 2px solid hsl(0, 0%, 75%);
        border-radius: 0.25rem;
        background-color: hsl(0, 0%, 100%);
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }

    /* Hover effect */
    input[type="checkbox"]:hover {
        border-color: hsl(0, 0%, 50%);
    }

    /* Checked state */
    input[type="checkbox"]:checked {
        background-color: hsl(0, 0%, 40%);
        border-color: hsl(0, 0%, 40%);
    }

    /* Focus state */
    input[type="checkbox"]:focus {
        outline: none;
        box-shadow: 0 0 0 2px hsl(0, 0%, 20%);
    }

    /* Checkmark */
    input[type="checkbox"]:checked::after {
        content: '';
        position: absolute;
        left: 0.4rem;
        top: 0.1rem;
        width: 0.35rem;
        height: 0.7rem;
        border: solid hsl(0, 0%, 100%);
        border-width: 0 2px 2px 0;
        transform: rotate(45deg);
    }
</style>

<style>
    /********** Universal Number Input Styles (Static) **********/
    input[type="number"] {
        -webkit-appearance: none;
        -moz-appearance: textfield;
        /* Firefox default */
        appearance: none;

        width: 6rem;
        padding: 0.25rem 0.5rem;
        border: 2px solid hsl(0, 0%, 75%);
        border-radius: 0.25rem;
        background-color: hsl(0, 0%, 100%);
        color: hsl(0, 0%, 20%);
        font-size: 1rem;
        cursor: text;
    }

    /* Remove arrows in Chrome, Safari, Edge */
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }

    /* Remove arrows in Firefox */
    input[type="number"] {
        -moz-appearance: textfield;
    }

    /* Optional: active state mimic slider thumb */
    input[type="number"]:active {
        border-color: hsl(0, 0%, 40%);
        background-color: hsl(0, 0%, 95%);
    }
</style>


<style>
    /********** Range Input Styles **********/
    /*Range Reset*/
    input[type="range"] {
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        cursor: pointer;
        width: 15rem;
    }

    /* Removes default focus */
    input[type="range"]:focus {
        outline: none;
    }

    /***** Chrome, Safari, Opera and Edge Chromium styles *****/
    /* slider track */
    input[type="range"]::-webkit-slider-runnable-track {
        background-color: hsl(0, 0%, 75%);
        border-radius: 3px;
        height: 0.5rem;
    }

    /* slider thumb */
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        /* Override default look */
        appearance: none;
        margin-top: -0.5rem;
        /* Centers thumb on the track */

        /*custom styles*/
        background-color: hsl(0, 0%, 40%);
        border-radius: 3px;
        height: 1.5rem;
        width: 1rem;
    }

    input[type="range"]:focus::-webkit-slider-thumb {
        background-color: hsl(0, 0%, 20%);
    }

    /******** Firefox styles ********/
    /* slider track */
    input[type="range"]::-moz-range-track {
        background-color: hsl(0, 0%, 75%);
        border-radius: 3px;
        height: 0.5rem;
    }

    /* slider thumb */
    input[type="range"]::-moz-range-thumb {
        border: none;
        /*Removes extra border that FF applies*/
        border-radius: 0;
        /*Removes default border-radius that FF applies*/

        /*custom styles*/
        background-color: hsl(0%, 0%, 40%);
        height: 1.5rem;
        width: 1rem;
    }

    input[type="range"]:focus::-moz-range-thumb {
        background-color: hsl(0, 0%, 20%);
    }
</style>

<style>
    #pad {
        position: absolute;

        top: 0;
        left: 0;
        right: 0;
        bottom: 0;

        background: black;

        display: flex;
        justify-content: center;
        align-items: center;
    }

    #controls {
        position: absolute;

        left: 50%;
        transform: translateX(-50%);

        bottom: 0;
        left: 50%;
        right: 50%;
        height: 8vh;
        width: 80vw;
        background: hsl(0, 0%, 90%);

        border-top-left-radius: 10px;
        border-top-right-radius: 10px;

        display: flex;
        justify-content: center;
        align-items: center;
        text-align: center;

        gap: 0.75rem
    }

    #controls label,
    span {
        color: hsl(0, 0%, 30%);
        font-size: 1.5rem;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: 600;
        user-select: none;
    }

    #label {
        display: flex;
        justify-content: center;
        flex-direction: column;
        align-items: center;
        text-align: center;
        margin-bottom: 5%;
    }

    #label * {
        color: hsl(0, 0%, 70%, 60%);
        font-size: 6vmin;
        font-family: Arial, Helvetica, sans-serif;
        font-weight: 700;
        user-select: none;
    }

    #frequency {
        font-size: 12vmin;
        font-weight: 800;
    }

    #volume {
        font-size: 8vmin;
        font-weight: 700;
    }
</style>

<body>
    <div id="pad">
        <div id="label">
            <span id="frequency"></span>
            <br>
            <span id="volume"></span>
        </div>
    </div>

    <div id="controls">
        <label for="distortion">Distortion: </label>
        <input type="range" min="0" max="7" step="1" value="1" id="distortion">
        <label for="reverb">Reverb: </label>
        <input type="checkbox" value="false" id="reverb">
        <label for="attack">Attack/Release: </label>
        <input type="number" id="attack" min="0" max="10" step="0.05" value="0.15">
        <input type="number" id="release" min="0" max="10" step="0.05" value="0.5">
    </div>
</body>

<script src="Tone.js"></script>

<script>
    function mapRange(value, inputMin, inputMax, outputMin, outputMax) {
        return ((value - inputMin) / (inputMax - inputMin)) * (outputMax - outputMin) + outputMin;
    }
</script>

<script>
    let initialized = false;
    let dragging = false;

    let lastX = 0;
    let lastY = 0;


    Tone.start();

    const synth = new Tone.Synth({
        envelope: {
            attack: 0.15,
            sustain: 1,
            release: 0.5
        }
    });
    const volume = new Tone.Volume(-12);
    // const filter = new Tone.Filter(4000, "lowpass");
    const reverb = new Tone.Reverb();
    reverb.wet.value = 0;
    const distortion = new Tone.Distortion(0);

    synth.connect(volume);
    volume.connect(reverb);
    reverb.connect(distortion);
    distortion.toDestination();

    const distortionLevels = [0, 0.05, 0.1, 0.2, 0.4, 0.6, 0.8, 1];
    let distortionLevel = 0;

    let controls = document.getElementById('controls');
    let distortionInput = document.getElementById('distortion');
    let reverbInput = document.getElementById('reverb');
    let attackInput = document.getElementById('attack');
    let releaseInput = document.getElementById('release');

    distortionLevel = distortionLevels[distortionInput.value];


    let pad = document.getElementById('pad');
    let label = document.getElementById('label');
    let frequencyLabel = document.getElementById('frequency');
    let volumeLabel = document.getElementById('volume');

    let padHeight = 0, padWidth = 0;

    function updatePadSize() {
        padHeight = pad.offsetHeight;
        padWidth = pad.offsetWidth
    }

    function getBackgroundColor(x) {
        let hue, saturation, lightness;

        if (dragging) {
            hue = Math.round((x / window.innerWidth) * 360);
            saturation = 85;
            lightness = 50;
        } else {
            hue = Math.round(((x / window.innerWidth) * 360) + 180);
            saturation = 10;
            lightness = 30;
        }

        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    function getLabelColor(x) {
        let hue, saturation, lightness;

        if (dragging) {
            hue = Math.round(((x / window.innerWidth) * 360) + 180);
            saturation = 100;
            lightness = 50;

            return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        } else {
            hue = Math.round((x / window.innerWidth) * 360);
            saturation = 10;
            lightness = 70;
        }

        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    }

    function calculateSynth(x, y) {
        const isVertical = padHeight > padWidth;

        let normX = Math.min(Math.max(x / padWidth, 0), 1);
        let normY = Math.min(Math.max((padHeight - y) / padHeight, 0), 1);

        let extreme1 = isVertical ? 0.05 : 0.04;
        let extreme2 = extreme1 * 2;
        let extreme3 = extreme2 * 2;

        let frequency;

        if (normX <= extreme1) {
            frequency = mapRange(normX, 0, extreme1, 20, 35);
        } else if (normX <= extreme2) {
            frequency = mapRange(normX, extreme1, extreme2, 35, 80);
        } else if (normX <= extreme3) {
            frequency = mapRange(normX, extreme2, extreme3, 80, 160);
        } else if (normX <= 1 - extreme3) {
            frequency = mapRange(normX, extreme3, 1 - extreme3, 160, 900);
        } else if (normX <= 1 - extreme2) {
            frequency = mapRange(normX, 1 - extreme3, 1 - extreme2, 900, 1200);
        } else if (normX <= 1 - extreme1) {
            frequency = mapRange(normX, 1 - extreme2, 1 - extreme1, 1200, 1800);
        } else {
            frequency = mapRange(normX, 1 - extreme1, 1, 1800, 2400);
        }

        let volume;
        if (normY <= 0.1) {
            volume = -40
        } else if (normY <= 0.25) {
            volume = mapRange(normY, 0.1, 0.25, -40, -10);
        } else if (normY <= 0.9) {
            volume = mapRange(normY, 0.25, 0.9, -10, 10);
        } else {
            volume = mapRange(normY, 0.9, 1, 10, 20);
        }

        if (frequency <= 200) {
            let boost;
            if (frequency <= 60) {
                boost = mapRange(frequency, 20, 45, 25, 15);
            } else {
                boost = mapRange(frequency, 45, 150, 15, 0);
            }
            volume += boost;
            volume = Math.min(volume, 35);
        }

        return { frequency: frequency, volume: volume };
    }




    function updateFrequencyLabel(text = "CLICK / DRAG") {
        frequencyLabel.innerText = text;
    }

    function updateVolumeLabel(text = "0dB") {
        volumeLabel.innerText = text;
    }

    function updateColors(x, y) {
        pad.style.backgroundColor = getBackgroundColor(x);
        frequencyLabel.style.color = getLabelColor(x);
        volumeLabel.style.color = getLabelColor(x)
    }

    function updateDisplay(x, y) {
        const values = calculateSynth(x, y)
        updateFrequencyLabel(Math.round(values.frequency) + "Hz");
        updateVolumeLabel(Math.round(values.volume) + "dB");
        if (x == 0 && y == 0) {
            updateFrequencyLabel();
            updateVolumeLabel();
        }
        updateColors(x, y);
    }

    function setDragging(value) {
        dragging = value;

        if (!initialized && dragging) {
            initialized = true;
        }

        if (dragging) {
            label.classList.add('dragging');
        } else {
            label.classList.remove('dragging');
        }
    }

    function down(event) {
        setDragging(true);

        let x = event.pageX;
        let y = event.pageY;

        updateDisplay(x, y);

        const values = calculateSynth(x, y);

        synth.triggerAttack(values.frequency);
        volume.volume.value = values.volume;
    }

    function move(event) {
        let x = event.pageX;
        let y = event.pageY;

        lastX = x;
        lastY = y;

        if (!initialized) {
            return;
        }

        updateDisplay(x, y);

        const values = calculateSynth(x, y);

        synth.setNote(values.frequency);
        volume.volume.value = values.volume;
    }

    function up(event) {
        setDragging(false);

        let x = event.pageX;
        let y = event.pageY;

        updateDisplay(x, y);

        synth.triggerRelease();
    }

    function updateDistortionLevel(input) {
        distortionLevel = input
        distortionLevel = Math.max(Math.min(distortionLevel, distortionLevels.length - 1), 0);
        distortion.distortion = distortionLevels[distortionLevel];
        distortionInput.value = distortionLevel
    }

    function updateReverb() {
        reverb.wet.value = reverbInput.checked ? 0.5 : 0
    }

    function updateAttack() {
        synth.envelope.attack = attackInput.valueAsNumber;
        synth.envelope.sustain = Math.max(10, attackInput.valueAsNumber);
    }

    function updateRelease() {
        synth.envelope.release = releaseInput.valueAsNumber;
    }

    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.key === ' ') {
            if (dragging || !initialized) {
                return
            }

            const pointerEvent = new PointerEvent('pointerdown', {
                bubbles: true,
                cancelable: true,
                pointerId: 1,
                pointerType: 'mouse',
                isPrimary: true,
                pageX: lastX,
                pageY: lastY,
                clientX: lastX,
                clientY: lastY,
                button: 0
            });

            pad.dispatchEvent(pointerEvent);
        } else if (e.key === 'q') {
            updateDistortionLevel(parseInt(distortionInput.value, 10) + 1)
        } else if (e.key === 'a') {
            updateDistortionLevel(parseInt(distortionInput.value, 10) - 1)
        } else if (e.key === 'r') {
            reverbInput.checked = !reverbInput.checked;
            updateReverb();
        }
    });

    document.addEventListener('keyup', (e) => {
        if (e.code === 'Space' || e.key === ' ') {
            if (!dragging || !initialized) {
                return
            }

            const pointerEvent = new PointerEvent('pointerup', {
                bubbles: true,
                cancelable: true,
                pointerId: 1,
                pointerType: 'mouse',
                isPrimary: true,
                pageX: lastX,
                pageY: lastY,
                clientX: lastX,
                clientY: lastY,
                button: 0
            });

            pad.dispatchEvent(pointerEvent);
        }
    });



    document.addEventListener('DOMContentLoaded', () => {
        updateDisplay(0, 0);
        updatePadSize();

        pad.addEventListener('pointerdown', down);
        pad.addEventListener('pointermove', move);
        pad.addEventListener('pointerup', up);

        distortionInput.addEventListener('input', function () {
            inp = parseInt(distortionInput.value, 10);
            updateDistortionLevel(inp);
        });

        reverbInput.addEventListener('change', function (event) {
            updateReverb();
        });

        attackInput.addEventListener('change', function (event) {
            updateAttack();
        });
        attackInput.addEventListener('input', function (event) {
            updateAttack();
        });

        releaseInput.addEventListener('change', function (event) {
            updateRelease();
        });
        releaseInput.addEventListener('input', function (event) {
            updateRelease();
        });
    });

    window.addEventListener("resize", (event) => {
        updatePadSize();
    });
</script>

</html>